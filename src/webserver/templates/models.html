{% extends "base.html" %}

{% block title %}Modelos - Asistente Virtual{% endblock %}

{% block content %}
<!-- Tabs de navegaci√≥n -->
<div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;">
    <button class="btn" onclick="showTab('llm')" id="tab-llm">üß† Modelos LLM</button>
    <button class="btn" onclick="showTab('tts')" id="tab-tts">üîä Voces TTS</button>
    <button class="btn" onclick="showTab('network')" id="tab-network">üì∂ Red / WiFi</button>
</div>

<!-- TAB: Modelos LLM -->
<div id="panel-llm" class="tab-panel">
    <div class="card">
        <h2>üì• Modelos de Lenguaje (LLM)</h2>
        <p style="color: #888; margin-bottom: 20px;">
            Selecciona un modelo para descargar. Los modelos se descargan desde HuggingFace.
            <br><small style="color: #666;">Los modelos recomendados est√°n optimizados para la NPU RK3588.</small>
        </p>

        <!-- Selector de modelo -->
        <div style="margin-bottom: 20px;">
            <label>Selecciona un modelo:</label>
            <select id="modelSelect" onchange="updateModelInfo()">
                <option value="">-- Seleccionar --</option>
            </select>
        </div>

        <!-- Opciones de descarga m√∫ltiple -->
        <div style="margin-bottom: 20px; padding: 10px; background: rgba(0,217,255,0.05); border-radius: 8px;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="multiDownloadMode" onchange="toggleMultiDownloadMode()">
                <span>üì• Modo descarga m√∫ltiple (seleccionar varios modelos)</span>
            </label>
        </div>

        <!-- Lista para descarga m√∫ltiple -->
        <div id="multiDownloadList" style="display: none; margin-bottom: 20px;">
            <h4>Selecciona los modelos a descargar:</h4>
            <div id="multiDownloadCheckboxes" style="max-height: 200px; overflow-y: auto; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px;"></div>
            <button class="btn" onclick="downloadMultipleModels()" style="margin-top: 10px;">
                üì• Descargar seleccionados (<span id="selectedCount">0</span>)
            </button>
        </div>

        <!-- Info del modelo seleccionado -->
        <div id="modelInfo" style="display: none; margin-bottom: 20px; padding: 15px; background: rgba(0,217,255,0.1); border-radius: 10px;">
            <h3 id="modelInfoName" style="color: #00d9ff; margin-bottom: 10px;"></h3>
            <p id="modelInfoDesc"></p>
            <p style="margin-top: 10px;">
                <strong>Tama√±o:</strong> <span id="modelInfoSize"></span>
            </p>
        </div>

        <!-- Bot√≥n de descarga -->
        <button id="downloadBtn" class="btn" onclick="downloadModel()" disabled>
            üì• Descargar Modelo
        </button>

        <!-- Spinner -->
        <div class="spinner" id="spinner">
            <svg width="50" height="50" viewBox="0 0 50 50">
                <circle cx="25" cy="25" r="20"></circle>
            </svg>
        </div>

        <!-- Barra de progreso -->
        <div class="progress-bar" id="progressBar">
            <div class="fill" id="progressFill"></div>
        </div>
        <p id="progressText" style="text-align: center; margin-top: 10px; display: none;">Descargando... <span id="progressPercent">0</span>%</p>
    </div>

    <div class="card">
        <h2>üì¶ Modelos Instalados</h2>
        <div id="installedModels">
            <p style="color: #888;">Cargando...</p>
        </div>
    </div>

    <div class="card">
        <h2>üìã Modelos Disponibles</h2>
        <div class="model-grid" id="availableModels">
            <p style="color: #888;">Cargando...</p>
        </div>
    </div>
</div>

<!-- TAB: Voces TTS -->
<div id="panel-tts" class="tab-panel" style="display: none;">
    <div class="card">
        <h2>üîä Voces de Piper TTS</h2>
        <p style="color: #888; margin-bottom: 20px;">
            Selecciona y descarga voces para el sintetizador de voz.
            <br><small style="color: #666;">Las voces est√°n organizadas por idioma.</small>
        </p>

        <!-- Voz actual -->
        <div style="margin-bottom: 20px; padding: 15px; background: rgba(0,255,136,0.1); border-radius: 10px;">
            <h3 style="color: #00ff88; margin-bottom: 5px;">üéôÔ∏è Voz Actual</h3>
            <p id="currentVoiceDisplay" style="font-size: 1.1rem;">Cargando...</p>
        </div>

        <!-- Tabs de idioma -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="btn" onclick="showVoiceLang('es_ES')" id="voice-lang-es_ES">üá™üá∏ Espa√±ol (ES)</button>
            <button class="btn" onclick="showVoiceLang('es_MX')" id="voice-lang-es_MX">üá≤üáΩ Espa√±ol (MX)</button>
            <button class="btn" onclick="showVoiceLang('en_US')" id="voice-lang-en_US">üá∫üá∏ English (US)</button>
        </div>

        <!-- Lista de voces -->
        <div id="voicesList">
            <p style="color: #888;">Selecciona un idioma arriba...</p>
        </div>

        <!-- Barra de progreso para TTS -->
        <div class="progress-bar" id="progressBarTTS" style="margin-top: 20px; display: none;">
            <div class="fill" id="progressFillTTS"></div>
        </div>
        <p id="progressTextTTS" style="text-align: center; margin-top: 10px; display: none;">Descargando voz... <span id="progressPercentTTS">0</span>%</p>
    </div>
</div>

<!-- TAB: Red / WiFi -->
<div id="panel-network" class="tab-panel" style="display: none;">
    <!-- Estado de conexi√≥n actual -->
    <div class="card">
        <h2>üì∂ Estado de Red</h2>
        <div id="networkStatus">
            <p style="color: #888;">Cargando...</p>
        </div>
    </div>

    <!-- Escanear redes WiFi -->
    <div class="card">
        <h2>üîç Redes WiFi Disponibles</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="btn" onclick="scanWiFi()">üîÑ Escanear Redes</button>
            <span id="scanStatus" style="color: #888; align-self: center;"></span>
        </div>

        <div id="wifiNetworks">
            <p style="color: #888;">Haz clic en "Escanear Redes" para buscar WiFi...</p>
        </div>
    </div>

    <!-- Conexi√≥n manual -->
    <div class="card" style="display: none;" id="manualConnectCard">
        <h2>üîë Conectar a Red WiFi</h2>
        <form onsubmit="connectWiFi(event)">
            <div style="margin-bottom: 15px;">
                <label>SSID (nombre de red):</label>
                <input type="text" id="wifiSSID" required readonly style="background: rgba(255,255,255,0.05);">
            </div>
            <div style="margin-bottom: 15px;">
                <label>Contrase√±a:</label>
                <input type="password" id="wifiPassword" placeholder="Dejar vac√≠o si es red abierta">
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="submit" class="btn">üîå Conectar</button>
                <button type="button" class="btn" onclick="cancelConnect()">Cancelar</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedModel = null;
let selectedVoiceLang = 'es_ES';
let downloadCheckInterval = null;

// Inicializaci√≥n
showTab('llm');

// Funciones de tabs
function showTab(tabName) {
    document.querySelectorAll('.tab-panel').forEach(p => p.style.display = 'none');
    document.querySelectorAll('[id^="tab-"]').forEach(b => b.classList.remove('btn-primary'));
    document.getElementById('panel-' + tabName).style.display = 'block';
    document.getElementById('tab-' + tabName).classList.add('btn-primary');

    if (tabName === 'tts') loadTTSVoices();
    if (tabName === 'network') loadNetworkStatus();
}

// =================== LLM ===================
async function loadModels() {
    try {
        const data = await apiGet('/api/models/llm');

        // Cargar modelos disponibles en el select
        const select = document.getElementById('modelSelect');
        select.innerHTML = '<option value="">-- Seleccionar --</option>';

        data.available.forEach(model => {
            const option = document.createElement('option');
            option.value = model.name;
            option.textContent = model.name + (model.recommended ? ' ‚≠ê (Recomendado)' : '');
            select.appendChild(option);
        });

        // Mostrar modelos disponibles
        const grid = document.getElementById('availableModels');
        grid.innerHTML = data.available.map(model => `
            <div class="model-card" onclick="selectModelFromCard('${model.name}')" style="cursor: pointer;">
                <h3>${model.name}${model.recommended ? '<span class="badge">‚≠ê Recomendado</span>' : ''}</h3>
                <p class="size">üì¶ ${formatSize(model.size_mb)}</p>
                <p style="color: #888; margin-top: 10px;">${model.description}</p>
            </div>
        `).join('');

        // Mostrar modelos instalados
        updateInstalledModels(data.installed);
    } catch (error) {
        console.error('Error cargando modelos:', error);
        document.getElementById('availableModels').innerHTML =
            '<p style="color: #ff6b6b;">‚ùå Error cargando modelos: ' + error.message + '</p>';
        document.getElementById('installedModels').innerHTML =
            '<p style="color: #ff6b6b;">‚ùå Error cargando modelos instalados</p>';
    }
}

function updateInstalledModels(installed) {
    const container = document.getElementById('installedModels');

    if (installed.length === 0) {
        container.innerHTML = '<p style="color: #888;">No hay modelos instalados</p>';
        return;
    }

    container.innerHTML = installed.map(model => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px;">
            <span>üì¶ ${model}</span>
            <button class="btn btn-danger" onclick="deleteModel('${model}')" style="padding: 8px 15px; font-size: 0.85rem;">Eliminar</button>
        </div>
    `).join('');
}

function selectModelFromCard(name) {
    document.getElementById('modelSelect').value = name;
    updateModelInfo();
}

function updateModelInfo() {
    const select = document.getElementById('modelSelect');
    const name = select.value;

    if (!name) {
        document.getElementById('modelInfo').style.display = 'none';
        document.getElementById('downloadBtn').disabled = true;
        selectedModel = null;
        return;
    }

    apiGet('/api/models/llm').then(data => {
        const model = data.available.find(m => m.name === name);
        if (model) {
            selectedModel = model;
            document.getElementById('modelInfoName').textContent = model.name;
            document.getElementById('modelInfoDesc').textContent = model.description;
            document.getElementById('modelInfoSize').textContent = formatSize(model.size_mb);
            document.getElementById('modelInfo').style.display = 'block';
            document.getElementById('downloadBtn').disabled = false;
        }
    });
}

async function downloadModel() {
    if (!selectedModel) return;

    const data = await apiGet('/api/models/llm');
    if (data.installed.includes(selectedModel.name)) {
        alert('Este modelo ya est√° instalado');
        return;
    }

    document.getElementById('spinner').classList.add('active');
    document.getElementById('progressBar').classList.add('active');
    document.getElementById('progressText').style.display = 'block';
    document.getElementById('downloadBtn').disabled = true;

    await apiPost('/api/models/download', { model: selectedModel.name });
    downloadCheckInterval = setInterval(checkDownloadProgress, 500);
}

async function checkDownloadProgress() {
    const status = await apiGet('/api/models/download/status');

    document.getElementById('progressFill').style.width = status.progress + '%';
    document.getElementById('progressPercent').textContent = status.progress;

    if (status.error) {
        clearInterval(downloadCheckInterval);
        document.getElementById('spinner').classList.remove('active');
        document.getElementById('progressBar').classList.remove('active');
        document.getElementById('progressText').style.display = 'none';
        alert('Error descargando: ' + status.error);
        document.getElementById('downloadBtn').disabled = false;
        return;
    }

    if (!status.downloading && status.progress >= 100) {
        clearInterval(downloadCheckInterval);
        document.getElementById('spinner').classList.remove('active');
        document.getElementById('progressBar').classList.remove('active');
        document.getElementById('progressText').style.display = 'none';
        document.getElementById('downloadBtn').disabled = false;
        document.getElementById('progressFill').style.width = '0%';
        loadModels();
        document.getElementById('modelSelect').value = '';
        document.getElementById('modelInfo').style.display = 'none';
        selectedModel = null;
        alert('¬°Modelo descargado correctamente!');
    }
}

async function deleteModel(name) {
    if (!confirm(`¬øEliminar el modelo ${name}?`)) return;
    await apiPost('/api/models/delete', { model: name });
    loadModels();
}

// =================== TTS ===================
async function loadTTSVoices() {
    try {
        const data = await apiGet('/api/tts/voices');

        // Mostrar voz actual
        const currentDisplay = document.getElementById('currentVoiceDisplay');
        if (data.current) {
            const parts = data.current.split('-');
            if (parts.length >= 2) {
                currentDisplay.innerHTML = `<strong>${data.current}</strong><br><small>${parts[0]} - ${parts[1]}</small>`;
            } else {
                currentDisplay.textContent = data.current;
            }
        }

        // Mostrar voces del idioma seleccionado
        showVoiceLang(selectedVoiceLang, data);
    } catch (error) {
        console.error('Error cargando voces TTS:', error);
        document.getElementById('currentVoiceDisplay').textContent = 'Error al cargar';
    }
}

function showVoiceLang(lang, cachedData = null) {
    selectedVoiceLang = lang;

    // Actualizar botones de idioma
    document.querySelectorAll('[id^="voice-lang-"]').forEach(b => b.classList.remove('btn-primary'));
    document.getElementById('voice-lang-' + lang)?.classList.add('btn-primary');

    const loadData = cachedData || apiGet('/api/tts/voices');

    loadData.then(data => {
        const voices = data.available[lang] || [];
        const listContainer = document.getElementById('voicesList');

        if (voices.length === 0) {
            listContainer.innerHTML = '<p style="color: #888;">No hay voces disponibles para este idioma.</p>';
            return;
        }

        listContainer.innerHTML = voices.map(voice => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px;">
                <div>
                    <strong>${voice.name}</strong>
                    ${voice.recommended ? '<span class="badge">‚≠ê Recomendado</span>' : ''}
                    <br><small style="color: #888;">${voice.quality} ‚Ä¢ ${voice.size_mb} MB</small>
                    ${voice.installed ? '<span style="color: #00ff88;"> ‚úì Instalada</span>' : ''}
                </div>
                <div style="display: flex; gap: 10px;">
                    ${voice.installed
                        ? `<button class="btn" onclick="setVoice('${voice.id}')" ${data.current === voice.id ? 'disabled' : ''}>
                            ${data.current === voice.id ? '‚úì Actual' : 'Usar'}
                           </button>`
                        : `<button class="btn" onclick="downloadVoice('${voice.id}')">üì• Descargar</button>`
                    }
                </div>
            </div>
        `).join('');
    });
}

async function downloadVoice(voiceId) {
    const result = await apiPost('/api/tts/voices/download', { voice_id: voiceId });

    if (result.success) {
        document.getElementById('progressBarTTS').style.display = 'block';
        document.getElementById('progressTextTTS').style.display = 'block';

        // Poll de progreso
        const checkInterval = setInterval(async () => {
            const status = await apiGet('/api/models/download/status');

            document.getElementById('progressFillTTS').style.width = status.progress + '%';
            document.getElementById('progressPercentTTS').textContent = status.progress;

            if (status.error) {
                clearInterval(checkInterval);
                document.getElementById('progressBarTTS').style.display = 'none';
                document.getElementById('progressTextTTS').style.display = 'none';
                alert('Error: ' + status.error);
            }

            if (!status.downloading && status.progress >= 100) {
                clearInterval(checkInterval);
                document.getElementById('progressBarTTS').style.display = 'none';
                document.getElementById('progressTextTTS').style.display = 'none';
                document.getElementById('progressFillTTS').style.width = '0%';
                loadTTSVoices();
                alert('¬°Voz descargada!');
            }
        }, 500);
    }
}

async function setVoice(voiceId) {
    await apiPost('/api/tts/voices/set', { voice_id: voiceId });
    loadTTSVoices();
    alert('Voz establecida como actual');
}

// =================== Network / WiFi ===================
async function loadNetworkStatus() {
    try {
        const status = await apiGet('/api/wifi/status');
        const container = document.getElementById('networkStatus');

        if (status.connected) {
            container.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 3rem;">üì∂</div>
                    <div>
                        <h3 style="color: #00ff88;">‚úì Conectado</h3>
                        ${status.ssid ? `<p><strong>SSID:</strong> ${status.ssid}</p>` : ''}
                        ${status.ip ? `<p><strong>IP:</strong> ${status.ip}</p>` : ''}
                        ${status.signal ? `<p><strong>Se√±al:</strong> ${status.signal}%</p>` : ''}
                    </div>
                </div>
            `;
        } else {
            container.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 3rem;">üì°</div>
                    <div>
                        <h3 style="color: #ff6b6b;">‚úó No conectado</h3>
                        <p style="color: #888;">Escanea redes WiFi disponibles</p>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error cargando estado de red:', error);
        document.getElementById('networkStatus').innerHTML =
            '<p style="color: #ff6b6b;">‚ùå Error cargando estado de red: ' + error.message + '</p>';
    }
}

async function scanWiFi() {
    const statusEl = document.getElementById('scanStatus');
    statusEl.textContent = 'Escaneando...';

    try {
        const data = await apiGet('/api/wifi');
        const container = document.getElementById('wifiNetworks');

        if (!data.networks || data.networks.length === 0) {
            container.innerHTML = '<p style="color: #888;">No se encontraron redes WiFi</p>';
        } else {
            container.innerHTML = data.networks.map(net => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px; cursor: pointer;"
                     onclick="selectNetwork('${net.ssid.replace(/'/g, "\\'")}', ${net.secured})">
                    <div>
                        <strong>${net.ssid}</strong>
                        ${net.secured ? 'üîí' : 'üîì'}
                        <br><small style="color: #888;">Canal ${net.channel}</small>
                    </div>
                    <div>
                        ${'‚ñÆ'.repeat(net.signal_bars)}<span style="color: #444;">${'‚ñØ'.repeat(4 - net.signal_bars)}</span>
                        <br><small>${net.signal}%</small>
                    </div>
                </div>
            `).join('');
        }

        statusEl.textContent = '';
    } catch (e) {
        statusEl.textContent = 'Error: ' + (e.error || 'Desconocido');
    }
}

function selectNetwork(ssid, secured) {
    document.getElementById('wifiSSID').value = ssid;
    document.getElementById('wifiPassword').value = '';
    document.getElementById('wifiPassword').required = secured;
    document.getElementById('manualConnectCard').style.display = 'block';
}

function cancelConnect() {
    document.getElementById('manualConnectCard').style.display = 'none';
}

async function connectWiFi(e) {
    e.preventDefault();

    const ssid = document.getElementById('wifiSSID').value;
    const password = document.getElementById('wifiPassword').value;

    const statusEl = document.getElementById('scanStatus');
    statusEl.textContent = 'Conectando...';

    try {
        await apiPost('/api/wifi/connect', { ssid, password });
        document.getElementById('manualConnectCard').style.display = 'none';
        statusEl.textContent = '';

        // Esperar y recargar estado
        setTimeout(() => {
            loadNetworkStatus();
        }, 2000);

        alert('Conectando a ' + ssid + '...');
    } catch (e) {
        statusEl.textContent = 'Error: ' + (e.error || 'Desconocido');
    }
}

// =================== DESCARGA M√öLTIPLE ===================
let multiDownloadMode = false;

function toggleMultiDownloadMode() {
    multiDownloadMode = document.getElementById('multiDownloadMode').checked;
    document.getElementById('multiDownloadList').style.display = multiDownloadMode ? 'block' : 'none';

    if (multiDownloadMode) {
        loadMultiDownloadList();
    }
}

async function loadMultiDownloadList() {
    const data = await apiGet('/api/models/llm');
    const installed = new Set(data.installed);
    const container = document.getElementById('multiDownloadCheckboxes');

    container.innerHTML = data.available
        .filter(m => !installed.has(m.name))
        .map(model => `
            <label style="display: block; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                <input type="checkbox" class="model-checkbox" value="${model.name}" onchange="updateSelectedCount()">
                ${model.name}${model.recommended ? ' ‚≠ê' : ''} - ${model.description} (${formatSize(model.size_mb)})
            </label>
        `).join('');
}

function updateSelectedCount() {
    const count = document.querySelectorAll('.model-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = count;
}

async function downloadMultipleModels() {
    const checkboxes = document.querySelectorAll('.model-checkbox:checked');
    const models = Array.from(checkboxes).map(cb => cb.value);

    if (models.length === 0) {
        alert('Selecciona al menos un modelo');
        return;
    }

    if (!confirm(`¬øDescargar ${models.length} modelos?`)) return;

    // Descargar uno por uno
    for (const modelName of models) {
        await apiPost('/api/models/download', { model: modelName });

        // Esperar a que termine la descarga actual
        await new Promise(resolve => {
            const check = setInterval(async () => {
                const status = await apiGet('/api/models/download/status');
                if (status.error) {
                    alert('Error descargando ' + modelName + ': ' + status.error);
                    clearInterval(check);
                    resolve();
                } else if (!status.downloading && status.progress >= 100) {
                    clearInterval(check);
                    resolve();
                }
            }, 500);
        });
    }

    alert('Descargas completadas');
    loadModels();
    document.getElementById('multiDownloadMode').checked = false;
    toggleMultiDownloadMode();
}

// Utilidades
function formatSize(mb) {
    if (mb >= 1024) {
        return (mb / 1024).toFixed(1) + ' GB';
    }
    return mb + ' MB';
}

// Cargar modelos al iniciar (esperando a que el DOM est√© listo)
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM cargado, inicializando...');
    loadModels().catch(err => {
        console.error('Error inicial loadModels:', err);
    });
});

// Fallback: tambi√©n intentar cargar directamente por si acaso
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => loadModels());
} else {
    loadModels().catch(err => {
        console.error('Error fallback loadModels:', err);
    });
}
</script>
{% endblock %}
